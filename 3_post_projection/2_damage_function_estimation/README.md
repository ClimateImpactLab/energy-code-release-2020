## Post projection analysis

### Overview
- Codes in this folder estimate and plot damage functions from our projection system outputs. 
- To run codes in this directory:
  - change the `DB_data` variable at the top of each code to point to the location of the external data repository that contains our projection system outputs
  - change the `root` variable to point to the location of the `energy-code-release-2020` repo on your machine.  
- The purpose of the codes in this folder is to convert our impacts projections into empirical damage functions, and to estimate quantile regressions that will allow us to calculate Partial SCC uncertainty ranges.

### Guide to data used in this provess
- The input data to damage function estimation is housed in an external directory, under `code_release_data/projection_system_outputs/damage_function_estimation/`. 
- Raw projection system outputs are contained in `code_release_data/projection_system_outputs/damage_function_estimation/impact_values/`
- These files contain data that is long by GCM, RCP, IAM, year and price scenario. Each value corresponds to the global projected impact due to climate change under that GCM, RCP, IAM, price scenario for a given year. 
- The naming scheme for files in `impact_values` is as follows: 
  - `gcm_{damages_or_impacts}_OTHERIND_{fuel}_{price_scenario}_{ssp}{model_tag}.csv`, where: 
    - `damages_or_impacts` is damages if the units are dollars, and impacts if the units are GJ.
    - `fuel` is either electricity, other_energy, or total_energy.
    - `price_scenario` is one of the pricing scenarios we apply to our projected impacts to convert them into dollars. See Appendix D for more information. 
    - `ssp` is the Shared Socioeconomic Pathway scenario used in the projection to define our income and population covariates. We include some projection results for SSP2, SSP3, and SSP4 in this code release. 
    - `model_tag` refers to the projection specification. If this is blank, then we are refering to the main model described in the main text of the paper. Other options are `lininter` (which includes a linear time interaction, and aims to capture technological trends) and `lininter_double` (which deterministically doubles the time trend estimated in the `lininter` model).
- We also use Global Mean Surface Temperature Anomaly data, that contains GCM level warming relative to the average temperature in 2001-2010. These data are contained in: 
  - `code_release_data/projection_system_outputs/damage_function_estimation/GMTanom_all_temp_2001_2010.csv`
  - These data were generated by our cliamte team - please get in touch for more details. 

## Contents

### `1_take_draws.R`
- This code takes in projected GCM level means and variances, for a given RCP-IAM-year-price_scenario combination, and takes random draws from this distribution. We use these random draws for plotting purposes, and for running quantile regressions on. 
- Note, since we only run uncertainty calculations on our main-model, and for SSP3, we only take draws from GCM level impacts for this scenario and projection type. 
- Code inputs:
  - `code_release_data/projection_system_outputs/damage_function_estimation/impact_values/*`
- Code outputs:
  - `code_release_data/projection_system_outputs/damage_function_estimation/resampled_data/*`

### `2_plot_damage_function_fig_3.do`
- This code plots a visualisation of our empirical damage functions in the year 2099.
- It also plots density functions of the GMST anomolies at end of century.
- Code inputs:
  - `code_release_data/projection_system_outputs/damage_function_estimation/impact_values/*`
- Code outputs:
  - `fig_3/fig_3C_damage_function_*_2099_SSP3.pdf`
 
### `3_run_damage_functions.do`
- This code estimates damage functions for each price scenario, model, SSP combination for which we present an SCC in the paper. 
- To choose which scenarios to run, you can change the `ssp` and `model` locals at the top of the code. Note, only the main model can be run for scenarios other than SSP3.
- The damage function is estimated for all eight of our price scenarios for the main model SSP3. For other scenarios, we estimate a damage function only for the `price014` scenario.
- Details of this damage function estimation can be found in Step 4 of the Methods section of the paper. 
- Code inputs:
  - `code_release_data/projection_system_outputs/damage_function_estimation/impact_values/*`
- Code outputs:
  -  `code_release_data/projection_system_outputs/damage_function_estimation/coefficients/df_mean_output_*.csv`

### `4_run_quantile_regressions.do`
- This code generates quantile regression coefficients for our main model, SSP3 scenario. These coefficients are used in subsequent calculations related to SCC uncertainty.
- ***Note, this code is very computationally intensive, and will take many hours to run, even on a powerful server.***
- We run quantile regressions for each 5th percentile.
- Details of the calculations done in this code can be found in Step 4 of the Methods section of the paper. 
- Code inputs:
  - `code_release_data/projection_system_outputs/damage_function_estimation/impact_values/*`
- Code outputs:
  -  `code_release_data/projection_system_outputs/damage_function_estimation/coefficients/df_qreg_output_SSP3.csv`

### `5_plot_damage_function_over_time.do`
- This code plots damage functions for a selection of years, showing how our empirically derived damage functions evolve over time, for our main model, price014 SSP3 scenario.
- Code inputs:
  - `code_release_data/projection_system_outputs/damage_function_estimation/GMTanom_all_temp_2001_2010.csv`
  - `code_release_data/projection_system_outputs/damage_function_estimation/coefficients/df_mean_output_SSP3.csv`
- Code outputs:
  - `fig_Appendix-E1_total_energy_damage_function_evolution_SSP3-price014.pdf`






